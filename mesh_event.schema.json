{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://orca-mesh.io/schemas/mesh-event.schema.json",
  "title": "Mesh Event Contract",
  "description": "Normalized event schema for ORCA mesh - adapters transform external events to this format",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "event_id",
    "event_type",
    "source",
    "timestamp",
    "version",
    "data"
  ],
  "properties": {
    "event_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this event (idempotency key)"
    },
    "correlation_id": {
      "type": "string",
      "format": "uuid",
      "description": "Correlation ID for distributed tracing"
    },
    "causation_id": {
      "type": "string",
      "format": "uuid",
      "description": "ID of the event that caused this event"
    },
    "event_type": {
      "type": "string",
      "enum": [
        "agent.registered",
        "agent.updated",
        "agent.suspended",
        "agent.deleted",
        "workflow.started",
        "workflow.completed",
        "workflow.failed",
        "workflow.cancelled",
        "data.synchronized",
        "data.drift_detected",
        "policy.violated",
        "policy.updated",
        "integration.connected",
        "integration.disconnected",
        "integration.error",
        "telemetry.metric",
        "telemetry.trace",
        "telemetry.log",
        "trust.score_updated",
        "security.threat_detected",
        "compliance.violation"
      ],
      "description": "Type of event using dot notation"
    },
    "source": {
      "type": "object",
      "required": ["adapter", "agent_id"],
      "properties": {
        "adapter": {
          "type": "string",
          "enum": ["mcp", "zapier", "make", "n8n", "airflow", "lambda", "internal"],
          "description": "Adapter that generated this event"
        },
        "agent_id": {
          "type": "string",
          "description": "ID of the agent/workflow that generated this event"
        },
        "integration_type": {
          "type": "string",
          "description": "Specific integration type (e.g., 'salesforce', 'hubspot')"
        },
        "region": {
          "type": "string",
          "description": "Geographic region of event origin"
        }
      }
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of event occurrence"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version (semver)"
    },
    "data": {
      "type": "object",
      "description": "Event-specific payload",
      "additionalProperties": true
    },
    "metadata": {
      "type": "object",
      "properties": {
        "tenant_id": {
          "type": "string",
          "description": "Multi-tenant identifier"
        },
        "user_id": {
          "type": "string",
          "description": "User who triggered the event"
        },
        "session_id": {
          "type": "string",
          "description": "Session identifier"
        },
        "ip_address": {
          "type": "string",
          "format": "ipv4",
          "description": "Source IP address"
        },
        "user_agent": {
          "type": "string",
          "description": "User agent string"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Custom tags for categorization"
        },
        "priority": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"],
          "default": "medium"
        },
        "retry_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of retry attempts"
        }
      }
    },
    "security": {
      "type": "object",
      "properties": {
        "signature": {
          "type": "string",
          "description": "HMAC signature for event validation"
        },
        "signature_algorithm": {
          "type": "string",
          "enum": ["hmac-sha256", "hmac-sha512"],
          "default": "hmac-sha256"
        },
        "classification": {
          "type": "string",
          "enum": ["public", "internal", "confidential", "restricted", "critical"],
          "default": "internal"
        },
        "requires_encryption": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "error": {
      "type": "object",
      "properties": {
        "code": {
          "type": "string",
          "description": "Error code"
        },
        "message": {
          "type": "string",
          "description": "Human-readable error message"
        },
        "category": {
          "type": "string",
          "enum": ["retryable", "non_retryable", "compensatable"],
          "description": "Error category for self-healing"
        },
        "stack_trace": {
          "type": "string",
          "description": "Stack trace (redacted in production)"
        },
        "context": {
          "type": "object",
          "description": "Additional error context"
        }
      }
    },
    "telemetry": {
      "type": "object",
      "properties": {
        "trace_id": {
          "type": "string",
          "description": "OpenTelemetry trace ID"
        },
        "span_id": {
          "type": "string",
          "description": "OpenTelemetry span ID"
        },
        "parent_span_id": {
          "type": "string",
          "description": "Parent span ID for nested traces"
        },
        "trace_flags": {
          "type": "string",
          "description": "OpenTelemetry trace flags"
        },
        "baggage": {
          "type": "object",
          "description": "OpenTelemetry baggage context"
        }
      }
    }
  },
  "examples": [
    {
      "event_id": "550e8400-e29b-41d4-a716-446655440000",
      "correlation_id": "123e4567-e89b-12d3-a456-426614174000",
      "event_type": "workflow.completed",
      "source": {
        "adapter": "zapier",
        "agent_id": "zap-12345",
        "integration_type": "salesforce",
        "region": "us-east-1"
      },
      "timestamp": "2025-10-30T14:30:00.000Z",
      "version": "1.0.0",
      "data": {
        "workflow_id": "wf-67890",
        "duration_ms": 1250,
        "steps_completed": 5,
        "result": "success"
      },
      "metadata": {
        "tenant_id": "acme-corp",
        "user_id": "user-123",
        "priority": "high",
        "tags": ["crm", "sales"]
      },
      "security": {
        "signature": "a1b2c3d4e5f6...",
        "signature_algorithm": "hmac-sha256",
        "classification": "confidential"
      },
      "telemetry": {
        "trace_id": "0af7651916cd43dd8448eb211c80319c",
        "span_id": "b7ad6b7169203331"
      }
    }
  ]
}
