# Disaster Recovery Configuration
# Failover policies, backup strategies, and recovery procedures

version: "1.0"
lastUpdated: "2025-10-30"

objectives:
  RTO: 300  # Recovery Time Objective in seconds (5 minutes)
  RPO: 60   # Recovery Point Objective in seconds (1 minute)
  availabilityTarget: 99.99  # Four nines

failoverPolicies:
  automatic:
    enabled: true
    healthCheckFailureThreshold: 3
    healthCheckInterval: 10  # seconds
    cooldownPeriod: 300  # seconds before allowing failback
    
  manual:
    requiresApproval: true
    approvers:
      - role: "VP_ENGINEERING"
      - role: "SRE_LEAD"
    notificationChannels:
      - slack: "#incidents"
      - pagerduty: "mesh-os-oncall"
      - email: "sre@meshos.io"

regionFailoverPairs:
  - primary: us-east-1
    secondary: us-west-2
    priority: 1
    trafficShift:
      strategy: gradual
      steps: [10, 25, 50, 75, 100]
      stepDuration: 60  # seconds
      
  - primary: us-west-2
    secondary: us-east-1
    priority: 1
    trafficShift:
      strategy: immediate
      
  - primary: eu-west-1
    secondary: eu-central-1
    priority: 1
    trafficShift:
      strategy: gradual
      steps: [25, 50, 100]
      stepDuration: 45
      
  - primary: eu-central-1
    secondary: eu-west-1
    priority: 1
    trafficShift:
      strategy: gradual
      steps: [25, 50, 100]
      stepDuration: 45
      
  - primary: ca-central-1
    secondary: us-east-1
    priority: 2
    trafficShift:
      strategy: immediate
      
  - primary: me-south-1
    secondary: eu-central-1
    priority: 2
    trafficShift:
      strategy: immediate
      
  - primary: ap-southeast-1
    secondary: us-west-2
    priority: 2
    trafficShift:
      strategy: immediate

backupStrategies:
  database:
    frequency: continuous  # continuous WAL streaming
    retention:
      daily: 30
      weekly: 12
      monthly: 12
    crossRegionBackup: true
    encryptionAtRest: true
    encryptionInTransit: true
    
  state:
    frequency: 300  # seconds (5 minutes)
    retention:
      snapshots: 50
    storageClass: "S3_STANDARD_IA"
    
  configuration:
    frequency: onchange
    versionControl: git
    retention: unlimited
    
  logs:
    frequency: realtime
    retention: 90  # days
    storageClass: "S3_GLACIER"
    
  metrics:
    frequency: realtime
    retention: 90  # days
    aggregationLevels:
      - raw: 7  # days
      - 1min: 30  # days
      - 1hour: 90  # days

recoveryProcedures:
  completeRegionFailure:
    - step: 1
      action: "Detect failure via health checks"
      automation: true
      timeout: 30
      
    - step: 2
      action: "Notify on-call team"
      automation: true
      timeout: 10
      
    - step: 3
      action: "Initiate DNS failover"
      automation: true
      timeout: 60
      
    - step: 4
      action: "Restore from latest backup in secondary region"
      automation: true
      timeout: 300
      
    - step: 5
      action: "Verify data consistency"
      automation: true
      timeout: 120
      
    - step: 6
      action: "Resume traffic to secondary region"
      automation: true
      timeout: 60
      
    - step: 7
      action: "Monitor for 24 hours"
      automation: false
      
  partialServiceDegradation:
    - step: 1
      action: "Identify affected services"
      automation: true
      
    - step: 2
      action: "Route traffic to healthy instances"
      automation: true
      
    - step: 3
      action: "Attempt service restart"
      automation: true
      maxRetries: 3
      
    - step: 4
      action: "Escalate if restart fails"
      automation: true
      
  dataCorruption:
    - step: 1
      action: "Detect corruption via checksums"
      automation: true
      
    - step: 2
      action: "Isolate affected data"
      automation: true
      
    - step: 3
      action: "Restore from last known good backup"
      automation: false
      requiresApproval: true
      
    - step: 4
      action: "Validate restored data"
      automation: true
      
    - step: 5
      action: "Resume operations"
      automation: false

testing:
  schedule:
    - type: tabletop
      frequency: monthly
      
    - type: failoverDrill
      frequency: quarterly
      
    - type: fullDR
      frequency: biannual
      
  lastTest: "2025-10-15"
  nextScheduled: "2026-01-15"
  successCriteria:
    - metric: "RTO achieved"
      threshold: "< 300 seconds"
    - metric: "RPO achieved"
      threshold: "< 60 seconds"
    - metric: "Data integrity"
      threshold: "100%"
    - metric: "Service availability"
      threshold: "> 99.9%"

monitoring:
  alerts:
    - name: "Region health check failed"
      severity: critical
      threshold: 3
      window: 30
      
    - name: "Replication lag high"
      severity: warning
      threshold: 5000  # milliseconds
      window: 60
      
    - name: "Backup failed"
      severity: critical
      threshold: 1
      
    - name: "Failover initiated"
      severity: critical
      notifyImmediate: true
      
  dashboards:
    - "DR Status Dashboard"
    - "Backup Health Dashboard"
    - "Replication Lag Dashboard"

compliance:
  auditLog: true
  retentionPeriod: 2555  # 7 years
  encryptionRequired: true
  accessControl: rbac
  annualReview: true
