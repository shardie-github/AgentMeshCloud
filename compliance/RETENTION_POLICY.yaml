# Data Retention Policy
# Aligned with catalogs, privacy requirements, and compliance standards

version: "1.0"
updated_at: "2025-10-31"
compliance_frameworks:
  - GDPR
  - SOC2
  - HIPAA
  - CCPA

# Global defaults
defaults:
  soft_delete: true
  backup_before_delete: true
  audit_deletions: true
  allow_manual_purge: false  # Requires approval

# Retention by data type
data_types:
  agent_registry:
    description: "Agent registration data, configs, metadata"
    retention_days: 365
    after_deletion: "anonymize"
    backup_retention_days: 730
    contains_pii: true
    classification: "internal"
    exceptions:
      - condition: "status == 'active'"
        retention_days: -1  # Keep indefinitely
      - condition: "plan == 'enterprise'"
        retention_days: 1825  # 5 years
    
  telemetry_metrics:
    description: "Performance metrics, latency, request counts"
    retention_days: 90
    after_deletion: "hard_delete"
    backup_retention_days: 0
    contains_pii: false
    classification: "internal"
    exceptions:
      - condition: "plan == 'free'"
        retention_days: 7
      - condition: "plan == 'pro'"
        retention_days: 30
      - condition: "plan == 'enterprise'"
        retention_days: 90
    
  api_logs:
    description: "Request/response logs, headers, bodies"
    retention_days: 30
    after_deletion: "hard_delete"
    backup_retention_days: 90
    contains_pii: true
    classification: "confidential"
    redact_fields: ["api_key", "bearer_token", "password", "ssn", "credit_card"]
    exceptions:
      - condition: "status_code >= 400"
        retention_days: 90  # Keep errors longer
    
  audit_logs:
    description: "Security audit trail, policy evaluations, access logs"
    retention_days: 2555  # 7 years
    after_deletion: "archive_to_glacier"
    backup_retention_days: 3650  # 10 years
    contains_pii: true
    classification: "restricted"
    immutable: true  # Cannot be modified
    
  policy_violations:
    description: "Policy violation events, remediation actions"
    retention_days: 730  # 2 years
    after_deletion: "anonymize"
    backup_retention_days: 1095  # 3 years
    contains_pii: true
    classification: "confidential"
    
  workflow_executions:
    description: "Workflow run history, artifacts, logs"
    retention_days: 90
    after_deletion: "soft_delete"
    backup_retention_days: 180
    contains_pii: false
    classification: "internal"
    exceptions:
      - condition: "status == 'failed'"
        retention_days: 180  # Keep failures longer for debugging
    
  user_profiles:
    description: "User accounts, preferences, settings"
    retention_days: -1  # Keep while account active
    after_deletion: "anonymize"
    backup_retention_days: 90
    contains_pii: true
    classification: "restricted"
    deletion_triggers:
      - "account_closed"
      - "gdpr_right_to_be_forgotten"
    grace_period_days: 30  # Recover within 30 days
    
  billing_records:
    description: "Invoices, payments, subscription history"
    retention_days: 2555  # 7 years (tax requirement)
    after_deletion: "archive_to_glacier"
    backup_retention_days: 3650  # 10 years
    contains_pii: true
    classification: "restricted"
    immutable: true
    
  context_bus_messages:
    description: "Inter-agent messages, events"
    retention_days: 14
    after_deletion: "hard_delete"
    backup_retention_days: 0
    contains_pii: false
    classification: "internal"
    exceptions:
      - condition: "classification == 'restricted'"
        retention_days: 90
    
  ai_model_outputs:
    description: "LLM responses, embeddings, generated content"
    retention_days: 30
    after_deletion: "hard_delete"
    backup_retention_days: 0
    contains_pii: true
    classification: "confidential"
    redact_fields: ["pii_detected"]
    
  anomalies:
    description: "Detected anomalies, root cause analyses"
    retention_days: 365
    after_deletion: "soft_delete"
    backup_retention_days: 730
    contains_pii: false
    classification: "internal"

# Automated cleanup jobs
cleanup_jobs:
  daily_purge:
    schedule: "0 2 * * *"  # 2 AM UTC daily
    description: "Purge soft-deleted records past retention"
    tables:
      - telemetry_metrics
      - context_bus_messages
      - ai_model_outputs
    dry_run: false
    
  weekly_archive:
    schedule: "0 3 * * 0"  # 3 AM UTC Sunday
    description: "Archive old records to cold storage"
    tables:
      - api_logs
      - workflow_executions
      - anomalies
    destination: "s3://orca-archives/"
    
  monthly_audit:
    schedule: "0 4 1 * *"  # 4 AM UTC first of month
    description: "Generate retention compliance report"
    output: "compliance/retention_report.md"
    notify: ["compliance-team@orca.dev"]

# GDPR Right to be Forgotten
gdpr_deletion:
  scope:
    - user_profiles
    - api_logs
    - audit_logs (anonymize only)
    - billing_records (retain, anonymize)
  process:
    - step: "Validate request"
      sla_hours: 24
    - step: "Identify all user data"
      sla_hours: 48
    - step: "Anonymize/delete per policy"
      sla_hours: 72
    - step: "Confirm deletion"
      sla_hours: 120  # 5 days total
  exclusions:
    - "Legal hold records"
    - "Tax records (anonymized)"
    - "Fraud investigation data"

# Region-specific overrides
regional_overrides:
  eu:
    description: "GDPR compliance"
    default_retention_days: 90  # Stricter default
    require_explicit_consent: true
    allow_transfer_outside_eu: false
    
  us:
    description: "US regulations"
    default_retention_days: 365
    hipaa_applies: true  # For healthcare tenants
    
  apac:
    description: "APAC regulations"
    default_retention_days: 180
    cross_border_restrictions: true

# Compliance checks
compliance_checks:
  - name: "Retention limits enforced"
    query: "SELECT COUNT(*) FROM {table} WHERE created_at < NOW() - INTERVAL '{retention_days} days'"
    fail_if: "> 0"
    
  - name: "Audit logs immutable"
    query: "SELECT COUNT(*) FROM audit_logs WHERE updated_at > created_at"
    fail_if: "> 0"
    
  - name: "PII redacted in logs"
    query: "SELECT COUNT(*) FROM api_logs WHERE body ~* '(ssn|credit_card|passport)' AND redacted = false"
    fail_if: "> 0"

# Disaster recovery
disaster_recovery:
  backup_frequency: "daily"
  backup_retention_days: 90
  backup_locations:
    - "s3://orca-backups-us-east-1/"
    - "s3://orca-backups-eu-west-1/"
  restore_sla_hours: 4
  rpo_minutes: 60  # 1 hour max data loss
  rto_minutes: 240  # 4 hours max downtime
