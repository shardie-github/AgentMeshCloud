# Drift Policy Configuration - Self-Healing Engine
# Version: 1.0.0

version: "1.0.0"
last_updated: "2025-10-30T00:00:00Z"

# ============================================================================
# DRIFT DETECTION
# ============================================================================
drift_detection:
  enabled: true
  scan_interval_minutes: 15
  
  # Configuration Drift
  configuration_drift:
    enabled: true
    baseline_source: "mcp_registry.yaml"
    threshold_percent: 5.0
    actions:
      - "alert"
      - "log"
      - "auto_correct"  # If safe
      
  # Data Drift
  data_drift:
    enabled: true
    metrics:
      - "data_freshness"
      - "schema_changes"
      - "value_distribution"
    threshold: 0.15  # 15% drift triggers alert
    actions:
      - "alert"
      - "trigger_resync"
      
  # Model Drift
  model_drift:
    enabled: true
    metrics:
      - "accuracy_degradation"
      - "latency_increase"
      - "error_rate_spike"
    thresholds:
      accuracy_drop_percent: 5.0
      latency_increase_percent: 50.0
      error_rate_threshold: 0.10
    actions:
      - "alert"
      - "trigger_retraining"  # If configured

# ============================================================================
# SELF-HEALING POLICIES
# ============================================================================
self_healing:
  enabled: true
  max_attempts: 3
  backoff_strategy: "exponential"
  base_delay_seconds: 5
  
  # Error Categories
  error_categories:
    - category: "retryable"
      errors:
        - "timeout"
        - "rate_limit"
        - "connection_refused"
        - "service_unavailable"
      actions:
        - retry_with_backoff
        - circuit_breaker
      max_retries: 3
      
    - category: "non_retryable"
      errors:
        - "authentication_failed"
        - "authorization_denied"
        - "invalid_input"
        - "not_found"
      actions:
        - log_and_alert
        - quarantine_if_repeated
      max_retries: 0
      
    - category: "compensatable"
      errors:
        - "partial_failure"
        - "data_inconsistency"
      actions:
        - trigger_compensation
        - log_and_monitor
      compensation_timeout_seconds: 300

  # Circuit Breaker
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    timeout_seconds: 60
    half_open_requests: 3
    success_threshold: 2
    
  # Dead Letter Queue
  dlq:
    enabled: true
    max_age_hours: 48
    retry_schedule:
      - delay_seconds: 60
      - delay_seconds: 300
      - delay_seconds: 900
      - delay_seconds: 3600
    alert_on_entry: true

# ============================================================================
# SYNC POLICIES
# ============================================================================
sync_policies:
  # Data Synchronization
  data_sync:
    enabled: true
    strategies:
      - name: "real_time"
        interval_seconds: 0  # Event-driven
        priority: "high"
        max_lag_seconds: 10
        
      - name: "near_real_time"
        interval_seconds: 60
        priority: "medium"
        max_lag_seconds: 300
        
      - name: "batch"
        interval_seconds: 3600
        priority: "low"
        max_lag_hours: 24
        
    conflict_resolution:
      strategy: "last_write_wins"  # or "manual_review"
      version_tracking: true
      
  # Agent Registry Sync
  registry_sync:
    enabled: true
    check_interval_minutes: 5
    auto_discover: true
    auto_register: false  # Require manual approval
    
  # Policy Sync
  policy_sync:
    enabled: true
    check_interval_minutes: 1
    hot_reload: true
    validation_required: true

# ============================================================================
# QUARANTINE POLICIES
# ============================================================================
quarantine:
  enabled: true
  
  triggers:
    - condition: "repeated_authentication_failure"
      threshold: 5
      window_minutes: 10
      duration_hours: 24
      
    - condition: "policy_violation_critical"
      threshold: 1
      window_minutes: 1
      duration_hours: 48
      requires_manual_review: true
      
    - condition: "anomalous_behavior_detected"
      threshold: 3
      window_minutes: 30
      duration_hours: 12
      
    - condition: "shadow_ai_discovered"
      threshold: 1
      window_minutes: 1
      duration_hours: 168  # 7 days
      requires_manual_review: true
      
  actions:
    - "block_all_requests"
    - "alert_security_team"
    - "log_all_attempts"
    - "create_incident_ticket"

# ============================================================================
# HEALING ACTIONS
# ============================================================================
healing_actions:
  # Service Restart
  restart_service:
    enabled: true
    conditions:
      - "consecutive_failures > 10"
      - "memory_usage > 90%"
      - "response_time > 30s"
    cooldown_minutes: 15
    max_restarts_per_hour: 3
    
  # Scale Resources
  scale_resources:
    enabled: true
    auto_scale: true
    metrics:
      - "cpu_usage > 80%"
      - "memory_usage > 85%"
      - "request_queue_depth > 100"
    scale_up_increment: 1
    scale_down_wait_minutes: 30
    
  # Failover
  failover:
    enabled: true
    conditions:
      - "health_check_failures > 3"
      - "response_time > 10s"
    failover_targets:
      - "secondary_region"
      - "backup_service"
    automatic: true
    
  # Cache Clear
  cache_clear:
    enabled: true
    conditions:
      - "cache_hit_rate < 10%"
      - "stale_data_detected"
    selective: true  # Only clear affected keys
    
  # Database Reconnect
  db_reconnect:
    enabled: true
    conditions:
      - "connection_pool_exhausted"
      - "database_unreachable"
    max_attempts: 5
    backoff_seconds: 10

# ============================================================================
# MONITORING AND ALERTS
# ============================================================================
monitoring:
  health_checks:
    enabled: true
    interval_seconds: 30
    timeout_seconds: 10
    endpoints:
      - "/health"
      - "/ready"
      
  drift_metrics:
    enabled: true
    export_interval_seconds: 60
    metrics:
      - "drift_detection_count"
      - "auto_healing_success_rate"
      - "quarantine_count"
      - "sync_lag_seconds"
      - "circuit_breaker_state"
      
  alerts:
    channels:
      - "email"
      - "slack"
      - "pagerduty"
    severity_levels:
      - name: "info"
        channels: ["slack"]
        throttle_minutes: 60
        
      - name: "warning"
        channels: ["email", "slack"]
        throttle_minutes: 30
        
      - name: "critical"
        channels: ["email", "slack", "pagerduty"]
        throttle_minutes: 0  # No throttling

# ============================================================================
# REPORTING
# ============================================================================
reporting:
  enabled: true
  
  drift_report:
    frequency: "daily"
    format: "markdown"
    recipients:
      - "ops@acme.com"
      - "ai-ops@acme.com"
    include:
      - "drift_summary"
      - "healing_actions_taken"
      - "quarantine_events"
      - "sync_lag_metrics"
      
  healing_report:
    frequency: "weekly"
    format: "pdf"
    recipients:
      - "engineering@acme.com"
    include:
      - "success_rate"
      - "most_common_errors"
      - "recommendations"
      
  executive_summary:
    frequency: "monthly"
    format: "markdown"
    recipients:
      - "cto@acme.com"
      - "cio@acme.com"
    include:
      - "uptime_percentage"
      - "auto_healing_stats"
      - "cost_savings"
      - "risk_avoided"
