name: Release Certification

on:
  push:
    tags:
      - 'v*-rc.*'  # Trigger on RC tags
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to certify'
        required: true
        type: string

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # Job 1: RC Tag & Build
  rc-tag-and-build:
    name: 'RC Tag → Tests/Lint/Build'
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      commit-sha: ${{ steps.get-tag.outputs.sha }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get tag
        id: get-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run tests
        run: pnpm test
      
      - name: Run type checking
        run: pnpm typecheck
      
      - name: Run linting
        run: pnpm lint
      
      - name: Build
        run: pnpm build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            dist/
            .next/
          retention-days: 7

  # Job 2: Database Preflight
  db-preflight:
    name: 'DB Preflight → Shadow Migrations'
    runs-on: ubuntu-latest
    needs: rc-tag-and-build
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run migration preflight
        run: pnpm tsx scripts/supabase_preflight.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SHADOW_DATABASE_URL: ${{ secrets.SHADOW_DATABASE_URL }}
      
      - name: Create backup
        run: ./scripts/supabase_backup_now.sh
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Upload backup metadata
        uses: actions/upload-artifact@v3
        with:
          name: db-backup
          path: backups/*.json

  # Job 3: Performance Testing
  performance:
    name: 'Perf → k6 Load Test'
    runs-on: ubuntu-latest
    needs: rc-tag-and-build
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Run load test
        run: k6 run tests/perf/k6_load.js
        env:
          BASE_URL: ${{ secrets.STAGING_URL }}
          API_KEY: ${{ secrets.API_KEY }}
      
      - name: Upload load test results
        uses: actions/upload-artifact@v3
        with:
          name: load-test-results
          path: tests/perf/summary.json

  # Job 4: Chaos & DR
  chaos-and-dr:
    name: 'Chaos/DR → Failover Tests'
    runs-on: ubuntu-latest
    needs: rc-tag-and-build
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run chaos tests
        run: pnpm run chaos:test
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Run failover tests
        run: pnpm tsx chaos/failover_supabase.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Run DR check
        run: pnpm run dr:check
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Upload chaos results
        uses: actions/upload-artifact@v3
        with:
          name: chaos-results
          path: chaos/reports/*.json

  # Job 5: Security Gates
  security:
    name: 'Security → CodeQL/Deps/OPA'
    runs-on: ubuntu-latest
    needs: rc-tag-and-build
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript, typescript
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v4
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
      
      - name: Run dependency audit
        run: pnpm audit --audit-level moderate || true
      
      - name: Setup OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/
      
      - name: Validate OPA policies
        run: opa test security/opa_policies.rego -v
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: OpenAPI diff check
        run: pnpm tsx security/openapi_diff.ts openapi.yaml openapi.orca.yaml

  # Job 6: Frontend Quality
  frontend-quality:
    name: 'UI → Lighthouse/A11y/Visual'
    runs-on: ubuntu-latest
    needs: rc-tag-and-build
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install Playwright
        run: pnpm exec playwright install --with-deps
      
      - name: Run visual regression tests
        run: pnpm exec playwright test ui-tests/visual_regression.spec.ts
        env:
          BASE_URL: ${{ secrets.STAGING_URL }}
      
      - name: Setup Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x
      
      - name: Run Lighthouse CI
        run: lhci autorun --budget-path=ui-tests/lighthouse.budgets.json || true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: Upload Playwright results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-results
          path: |
            playwright-report/
            test-results/

  # Job 7: Canary Deploy
  canary-deploy:
    name: 'Canary → 1%→5%→25%→100%'
    runs-on: ubuntu-latest
    needs: [db-preflight, performance, chaos-and-dr, security, frontend-quality]
    environment:
      name: production
      url: https://orca-mesh.io
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
      
      - name: Install Vercel CLI
        run: npm install -g vercel
      
      - name: Deploy blue environment
        id: deploy-blue
        run: |
          DEPLOYMENT_URL=$(pnpm tsx deploy/vercel_blue_green.ts | grep "Blue deployed:" | cut -d' ' -f3)
          echo "deployment-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      
      - name: Run canary rollout
        run: pnpm tsx deploy/vercel_canary.ts --deployment-url=${{ steps.deploy-blue.outputs.deployment-url }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: Upload canary results
        uses: actions/upload-artifact@v3
        with:
          name: canary-results
          path: deploy/canary-*.json

  # Job 8: Promote or Rollback
  promote-or-rollback:
    name: 'Promote/Rollback → Decision'
    runs-on: ubuntu-latest
    needs: canary-deploy
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Check canary success
        id: check-canary
        run: |
          if [ "${{ needs.canary-deploy.result }}" == "success" ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Promote to production
        if: steps.check-canary.outputs.proceed == 'true'
        run: pnpm tsx release/promote.ts --rc=${{ needs.rc-tag-and-build.outputs.tag }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      
      - name: Rollback on failure
        if: steps.check-canary.outputs.proceed == 'false'
        run: pnpm tsx release/rollback.ts --reason="Canary deployment failed"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

  # Job 9: Evidence Pack
  evidence-pack:
    name: 'Evidence → Bundle & Upload'
    runs-on: ubuntu-latest
    needs: [promote-or-rollback]
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts/
      
      - name: Generate evidence pack
        run: pnpm tsx evidence/generate.ts --tag=${{ needs.rc-tag-and-build.outputs.tag }}
      
      - name: Upload evidence pack
        uses: actions/upload-artifact@v3
        with:
          name: evidence-pack
          path: evidence/pack-*.zip
          retention-days: 90
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: needs.promote-or-rollback.result == 'success'
        with:
          tag_name: ${{ needs.rc-tag-and-build.outputs.tag }}
          name: Release ${{ needs.rc-tag-and-build.outputs.tag }}
          body_path: release/notes-${{ needs.rc-tag-and-build.outputs.tag }}.md
          files: |
            evidence/pack-*.zip
          draft: false
          prerelease: false

  # Job 10: Notify
  notify:
    name: 'Notify → Stakeholders'
    runs-on: ubuntu-latest
    needs: [rc-tag-and-build, promote-or-rollback, evidence-pack]
    if: always()
    
    steps:
      - name: Send Slack notification (success)
        if: needs.promote-or-rollback.result == 'success'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "✅ ORCA Release ${{ needs.rc-tag-and-build.outputs.tag }} deployed successfully!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Release Certification Complete*\n\n*Tag:* ${{ needs.rc-tag-and-build.outputs.tag }}\n*Commit:* ${{ needs.rc-tag-and-build.outputs.commit-sha }}\n*Status:* ✅ Success"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Evidence Pack"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Send Slack notification (failure)
        if: needs.promote-or-rollback.result != 'success'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "❌ ORCA Release ${{ needs.rc-tag-and-build.outputs.tag }} FAILED!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Release Certification Failed*\n\n*Tag:* ${{ needs.rc-tag-and-build.outputs.tag }}\n*Status:* ❌ Failed\n*Reason:* Check workflow logs"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
