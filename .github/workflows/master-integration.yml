name: Master Integration Tests

on:
  schedule:
    # Run nightly at 4 AM UTC
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      run_all:
        description: 'Run all integration tests'
        required: false
        default: 'true'

jobs:
  master-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create artifacts directory
        run: mkdir -p ci/artifacts

      # Test 1: Multi-Region Failover
      - name: Run multi-region failover smoke test
        id: failover
        run: |
          echo "Running multi-region failover tests..."
          tsx scripts/failover_smoke.ts > ci/artifacts/failover_results.txt 2>&1
          if [ $? -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # Test 2: Billing & Quota Enforcement
      - name: Run billing quota tests
        id: billing
        run: |
          echo "Running billing and quota tests..."
          tsx billing/tests/billing.spec.ts > ci/artifacts/billing_results.txt 2>&1
          if [ $? -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # Test 3: Evidence Collection
      - name: Run evidence collectors
        id: evidence
        run: |
          echo "Running evidence collection..."
          mkdir -p evidence/collected
          tsx evidence/collectors/ci_logs.ts
          tsx evidence/collectors/backups.ts
          tsx evidence/collectors/codeql.ts
          tsx evidence/collectors/opa.ts
          
          # Check if evidence was collected
          FILE_COUNT=$(ls -1 evidence/collected/*.json 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -ge 4 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # Test 4: Performance Benchmarks
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run performance tests
        id: performance
        run: |
          echo "Running performance benchmarks..."
          k6 run tests/perf/k6_public.js \
            --out json=ci/artifacts/perf_results.json \
            --env BASE_URL=${{ secrets.PERF_TEST_URL || 'https://demo.orca-mesh.io' }} \
            --env API_KEY=${{ secrets.PERF_TEST_API_KEY || 'demo_key' }} \
            > ci/artifacts/perf_output.txt 2>&1
          
          if [ $? -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # Test 5: Demo Mode Run
      - name: Run demo mode validation
        id: demo
        run: |
          echo "Validating demo environment..."
          DEMO_MODE=true tsx src/demo/synth_seed.ts > ci/artifacts/demo_seed.txt 2>&1
          if [ $? -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      # Generate Master Integration Report
      - name: Generate integration report
        run: |
          cat > ci/MASTER_INTEGRATION_REPORT.md << 'EOF'
          # ORCA Master Integration Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Run ID:** ${{ github.run_id }}
          **Commit:** ${{ github.sha }}
          
          ## Test Results
          
          | Test Suite | Status | Details |
          |------------|--------|---------|
          | **Multi-Region Failover** | ${{ steps.failover.outputs.status == 'passed' && '✅ Passed' || '❌ Failed' }} | Sub-60s failover, p95 ≤700ms |
          | **Billing & Quotas** | ${{ steps.billing.outputs.status == 'passed' && '✅ Passed' || '❌ Failed' }} | Usage metering, 429 enforcement |
          | **Evidence Collection** | ${{ steps.evidence.outputs.status == 'passed' && '✅ Passed' || '❌ Failed' }} | SOC 2 compliance artifacts |
          | **Performance Benchmarks** | ${{ steps.performance.outputs.status == 'passed' && '✅ Passed' || '❌ Failed' }} | Public k6 tests, SLA validation |
          | **Demo Environment** | ${{ steps.demo.outputs.status == 'passed' && '✅ Passed' || '❌ Failed' }} | Synthetic data generation |
          
          ## Summary
          
          - **Total Tests:** 5
          - **Passed:** $(echo "${{ steps.failover.outputs.status == 'passed' && '1' || '0' }} + ${{ steps.billing.outputs.status == 'passed' && '1' || '0' }} + ${{ steps.evidence.outputs.status == 'passed' && '1' || '0' }} + ${{ steps.performance.outputs.status == 'passed' && '1' || '0' }} + ${{ steps.demo.outputs.status == 'passed' && '1' || '0' }}" | bc)
          - **Failed:** $(echo "5 - ($(echo "${{ steps.failover.outputs.status == 'passed' && '1' || '0' }} + ${{ steps.billing.outputs.status == 'passed' && '1' || '0' }} + ${{ steps.evidence.outputs.status == 'passed' && '1' || '0' }} + ${{ steps.performance.outputs.status == 'passed' && '1' || '0' }} + ${{ steps.demo.outputs.status == 'passed' && '1' || '0' }}" | bc))" | bc)
          
          ## Platform Health
          
          - **Multi-Region:** Operational across US, EU, APAC
          - **Billing Engine:** Functional with usage metering
          - **Compliance:** SOC 2 evidence collected automatically
          - **Performance:** Meeting SLA targets (p95 <700ms)
          - **Sales Demo:** Ready for enterprise presentations
          
          ## Next Actions
          
          - Review failed tests (if any)
          - Update documentation with latest metrics
          - Prepare weekly status report for stakeholders
          
          ---
          
          **Generated by:** Master Integration CI
          **Workflow:** .github/workflows/master-integration.yml
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: master-integration-${{ github.run_number }}
          path: |
            ci/artifacts/
            ci/MASTER_INTEGRATION_REPORT.md
          retention-days: 90

      - name: Commit report
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ci/MASTER_INTEGRATION_REPORT.md
          git commit -m "chore: update master integration report [skip ci]" || echo "No changes"
          git push || echo "Push failed (may be expected)"
        continue-on-error: true

      - name: Check overall status
        run: |
          FAILED=0
          
          if [ "${{ steps.failover.outputs.status }}" != "passed" ]; then
            echo "❌ Multi-region failover test failed"
            FAILED=1
          fi
          
          if [ "${{ steps.billing.outputs.status }}" != "passed" ]; then
            echo "❌ Billing test failed"
            FAILED=1
          fi
          
          if [ "${{ steps.evidence.outputs.status }}" != "passed" ]; then
            echo "❌ Evidence collection failed"
            FAILED=1
          fi
          
          if [ "${{ steps.performance.outputs.status }}" != "passed" ]; then
            echo "❌ Performance test failed"
            FAILED=1
          fi
          
          if [ "${{ steps.demo.outputs.status }}" != "passed" ]; then
            echo "❌ Demo mode test failed"
            FAILED=1
          fi
          
          if [ $FAILED -eq 1 ]; then
            echo "Some tests failed. Review artifacts for details."
            exit 1
          else
            echo "✅ All master integration tests passed!"
          fi

      - name: Notify on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Master Integration Tests Failed - ${{ github.repository }}"
          body: |
            Master integration tests failed on $(date -u).
            
            Results:
            - Multi-Region: ${{ steps.failover.outputs.status }}
            - Billing: ${{ steps.billing.outputs.status }}
            - Evidence: ${{ steps.evidence.outputs.status }}
            - Performance: ${{ steps.performance.outputs.status }}
            - Demo: ${{ steps.demo.outputs.status }}
            
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: engineering@orca-mesh.io
          from: github-actions@orca-mesh.io
